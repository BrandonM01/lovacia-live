<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lovacia Bot</title>
</head>
<body>
  <h1>Lovacia Bot</h1>

  <label>
    Select images:
    <input id="fileInput" type="file" multiple>
  </label>
  <button id="uploadBtn">Upload & Process</button>
  <button id="cancelBtn" style="display:none">Cancel</button>

  <h3>Original Thumbnail:</h3>
  <img id="origThumb" width="200" style="display:none">

  <h2>Progress:</h2>
  <div id="progress">Idle</div>

  <h2>Processed Images</h2>
  <div id="results"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const origThumb = document.getElementById('origThumb');
    const progress  = document.getElementById('progress');
    const results   = document.getElementById('results');

    let controller;

    // show thumb
    fileInput.onchange = () => {
      const f = fileInput.files[0];
      if (!f) return origThumb.style.display = 'none';
      const r = new FileReader();
      r.onload = e => {
        origThumb.src = e.target.result;
        origThumb.style.display = 'block';
      };
      r.readAsDataURL(f);
    };

    uploadBtn.onclick = async () => {
      if (!fileInput.files.length) return alert('Pick at least one file.');

      // UI prep
      results.innerHTML = '';
      progress.textContent = 'Starting…';
      uploadBtn.disabled = true;
      cancelBtn.style.display = '';

      controller = new AbortController();
      const form = new FormData();
      for (const f of fileInput.files) form.append('files', f);

      try {
        const res = await fetch('/upload', {
          method: 'POST',
          body:   form,
          signal: controller.signal
        });
        const json = await res.json();

        progress.textContent = `Done — ${json.processed.length} images`;
        for (const img of json.processed) {
          const a = document.createElement('a');
          a.href = img.download_link;
          a.download = '';
          const i = document.createElement('img');
          i.src = img.image;
          i.width = 200;
          a.appendChild(i);
          results.appendChild(a);
        }
      } catch (err) {
        if (err.name === 'AbortError') progress.textContent = 'Cancelled';
        else {
          console.error(err);
          progress.textContent = 'Error!';
        }
      } finally {
        uploadBtn.disabled = false;
        cancelBtn.style.display = 'none';
      }
    };

    cancelBtn.onclick = () => {
      if (controller) controller.abort();
    };
  </script>
</body>
</html>
