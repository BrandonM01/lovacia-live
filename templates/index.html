<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lovacia Bot</title>
  <!-- attach our CSS -->
  <link rel="stylesheet" href="{{ request.url_for('static', path='app.css') }}">
</head>
<body>

  <h1 class="title">Lovacia Bot</h1>

  <form id="uploadForm" enctype="multipart/form-data">
    <div class="field">
      <label>Select files (images & videos):</label>
      <input type="file" name="files" id="fileInput" multiple required>
    </div>
    <div id="origPreview" class="field"><strong>Original Thumbnails:</strong></div>
    <div class="field">
      <label>Batch size:
        <select name="count">
          <option>5</option><option>10</option><option>25</option><option>50</option>
        </select>
      </label>
      <label>Contrast Min (%):
        <input type="number" name="contrast_min" value="-5.0" step="0.1">
      </label>
      <label>Contrast Max (%):
        <input type="number" name="contrast_max" value="5.0" step="0.1">
      </label>
      <label>Flip horizontally:
        <input type="checkbox" name="flip">
      </label>
    </div>
    <div class="field">
      <button type="submit" id="uploadBtn">Upload & Process</button>
      <button type="button" id="cancelBtn" style="display:none;">Cancel</button>
    </div>
  </form>

  <!-- spinner overlay -->
  <div id="spinnerOverlay" style="display:none;">
    <div class="spinner"></div>
  </div>

  <h2>Current Batch</h2>
  <div id="imagePreview" class="gallery"></div>

  <h2>History</h2>
  <div id="history" class="gallery"></div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const origPreview = document.getElementById("origPreview");
    fileInput.onchange = () => {
      origPreview.innerHTML = "<strong>Original Thumbnails:</strong>";
      Array.from(fileInput.files).forEach(f=>{
        const img = document.createElement("img");
        img.src = URL.createObjectURL(f);
        origPreview.appendChild(img);
      });
    };

    let controller, jobId;
    const form = document.getElementById("uploadForm"),
          uploadBtn = document.getElementById("uploadBtn"),
          cancelBtn = document.getElementById("cancelBtn"),
          spinner = document.getElementById("spinnerOverlay"),
          preview = document.getElementById("imagePreview"),
          history = document.getElementById("history");

    form.onsubmit = async e=>{
      e.preventDefault();
      controller = new AbortController();
      uploadBtn.disabled = true;
      cancelBtn.style.display = "inline-block";
      spinner.style.display = "flex";
      preview.innerHTML = "";

      const data = new FormData(form);
      const resp = await fetch("/upload", { method:"POST", body:data, signal:controller.signal });
      const { job_id } = await resp.json();
      jobId = job_id;

      // SSE progress
      const evtSrc = new EventSource(`/progress/${job_id}`);
      evtSrc.onmessage = e=>{
        const { processed, total, batch_url } = JSON.parse(e.data);
        // can do a simple textual or numeric update here if you like...
        if(batch_url){
          // final!
          evtSrc.close();
          spinner.style.display = "none";
          uploadBtn.disabled = false;
          cancelBtn.style.display = "none";

          // pull results
          fetch(`/results/${job_id}`)
            .then(r=>r.json())
            .then(({items, batch_url})=>{
              // render Current Batch
              items.slice(-total).forEach(it=>{
                const img = document.createElement("img");
                img.src = it.image;
                preview.appendChild(img);
              });
              // append to History
              history.appendChild(preview.cloneNode(true));
            });
        }
      };
    };

    cancelBtn.onclick = ()=> controller.abort();
  </script>
</body>
</html>
