<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lovacia Bot</title>
  <style>
    body {
      max-width:600px; margin:auto; font-family:sans-serif; padding:2rem;
      text-align:center;
    }
    label { display:block; margin:1rem 0; }
    #origPreview img { max-width:100px; margin:.25rem; border:1px solid #ccc; }
    #imagePreview img { max-width:120px; margin:.5rem; border:1px solid #999; }
    #imagePreview { display:flex; flex-wrap:wrap; justify-content:center; }
    #progressBar {
      width:100%; background:#eee; border:1px solid #ccc; height:1rem; margin:1rem 0;
    }
    #progressFill {
      height:100%; width:0%; background:#28a745;
    }
    #batchDownload, #cancelBtn {
      margin:1rem;
    }
  </style>
</head>
<body>
  <h1>Lovacia Bot</h1>

  <form id="uploadForm" enctype="multipart/form-data">
    <label>
      Select images:
      <input type="file" id="fileInput" name="files" multiple required>
    </label>
    <div id="origPreview"><strong>Original Thumbnails:</strong></div>

    <label>Batch size:
      <select name="count">
        <option>5</option><option>10</option><option>25</option><option>50</option>
      </select>
    </label>
    <label>Contrast Min (%):
      <input type="number" name="contrast_min" value="-5.0" step="0.1">
    </label>
    <label>Contrast Max (%):
      <input type="number" name="contrast_max" value="5.0" step="0.1">
    </label>
    <label>Flip horizontally:
      <input type="checkbox" name="flip">
    </label>

    <button type="submit" id="uploadBtn">Upload & Process</button>
    <button type="button" id="cancelBtn" style="display:none;">Cancel</button>
  </form>

  <div id="preview">
    <h2>Processed Images</h2>
    <div id="progressBar"><div id="progressFill"></div></div>
    <div id="imagePreview"></div>
    <a id="batchDownload" href="#" download style="display:none;">Download ZIP</a>
  </div>

  <script>
    const fileInput    = document.getElementById("fileInput");
    const origPreview  = document.getElementById("origPreview");
    const form         = document.getElementById("uploadForm");
    const uploadBtn    = document.getElementById("uploadBtn");
    const cancelBtn    = document.getElementById("cancelBtn");
    const progressBar  = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");
    const imagePreview = document.getElementById("imagePreview");
    const batchDownload= document.getElementById("batchDownload");
    let es, jobId;

    fileInput.onchange = () => {
      origPreview.innerHTML = "<strong>Original Thumbnails:</strong>";
      Array.from(fileInput.files).forEach(f => {
        let img = document.createElement("img");
        img.src = URL.createObjectURL(f);
        origPreview.appendChild(img);
      });
    };

    form.onsubmit = async e => {
      e.preventDefault();
      // kick off the job
      const resp = await fetch("/upload", {
        method: "POST",
        body: new FormData(form),
      });
      ({ job_id: jobId } = await resp.json());

      // prep UI
      uploadBtn.disabled    = true;
      cancelBtn.style.display= "inline";
      imagePreview.innerHTML= "";
      progressFill.style.width = "0%";
      batchDownload.style.display = "none";

      // subscribe to SSE
      es = new EventSource(`/progress/${jobId}`);
      es.onmessage = ev => {
        const { processed, total, batch_url } = JSON.parse(ev.data);
        const pct = Math.round(processed/total * 100);
        progressFill.style.width = pct + "%";

        if (batch_url) {
          // done
          es.close();
          cancelBtn.style.display="none";
          batchDownload.href = batch_url;
          batchDownload.style.display="inline";
          // fetch and render processed images
          fetch(batch_url.replace("_batch_", ".")) // you'd adjust if needed
            .then(() => {
              // simply re-fetch the processed list via a lightweight endpoint
              fetch(`/upload?job=${jobId}`)
                .then(r=>r.json())
                .then(({processed})=>{
                  processed.forEach(item=>{
                    let img = document.createElement("img");
                    img.src = item.image;
                    imagePreview.appendChild(img);
                  });
                });
            });
        }
      };

      es.onerror = () => {
        es.close();
        cancelBtn.style.display="none";
      };
    };

    cancelBtn.onclick = () => {
      if (es) es.close();
      uploadBtn.disabled = false;
      cancelBtn.style.display = "none";
    };
  </script>
</body>
</html>
