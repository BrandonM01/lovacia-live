<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lovacia Bot</title>
  <style>
    body { max-width:700px; margin:auto; font-family:sans-serif; padding:1rem }
    label { display:block; margin:0.5rem 0 }
    img.thumb { width:100px; margin:0.25rem; border:1px solid #ccc }
    #progressContainer { margin:1rem 0; display:none }
    #bar { width:100%; height:1rem; background:#eee; border-radius:4px; overflow:hidden }
    #barInner { height:100%; width:0; background:#4a90e2; transition:width 0.2s }
    #eta { font-size:0.9rem; color:#666 }
    #batchDownload { display:none; margin-top:1rem }
  </style>
</head>
<body>
  <h1>Lovacia Bot</h1>
  <form id="uploadForm" enctype="multipart/form-data">
    <label>Select images
      <input type="file" id="fileInput" name="files" multiple required>
    </label>
    <div id="origPreview"><strong>Original Thumbnails:</strong></div>

    <label>Batch size:
      <select name="count">
        <option>5</option><option>10</option><option>25</option><option>50</option>
      </select>
    </label>
    <label>Contrast Min (%):
      <input type="number" name="contrast_min" value="-5.0" step="0.1">
    </label>
    <label>Contrast Max (%):
      <input type="number" name="contrast_max" value="5.0" step="0.1">
    </label>
    <label>Flip horizontally:
      <input type="checkbox" name="flip">
    </label>

    <button type="submit" id="uploadBtn">Upload &amp; Process</button>
  </form>

  <div id="progressContainer">
    <div id="bar"><div id="barInner"></div></div>
    <div id="eta"></div>
  </div>

  <h2>Processed Images</h2>
  <div id="imagePreview"></div>
  <a id="batchDownload" href="#" download>Download All Variations (ZIP)</a>

  <script>
    const fileInput = document.getElementById("fileInput");
    const origPreview = document.getElementById("origPreview");
    fileInput.onchange = ()=> {
      origPreview.innerHTML = "<strong>Original Thumbnails:</strong>";
      Array.from(fileInput.files).forEach(f=>{
        let img = document.createElement("img");
        img.src = URL.createObjectURL(f);
        img.className = "thumb";
        origPreview.appendChild(img);
      });
    };

    const form  = document.getElementById("uploadForm");
    const barC  = document.getElementById("progressContainer");
    const inner = document.getElementById("barInner");
    const eta   = document.getElementById("eta");
    const prev  = document.getElementById("imagePreview");
    const zipA  = document.getElementById("batchDownload");

    form.onsubmit = e=>{
      e.preventDefault();
      prev.innerHTML = "";
      inner.style.width = "0%";
      eta.textContent = "";
      zipA.style.display = "none";
      barC.style.display = "block";
      document.getElementById("uploadBtn").disabled = true;

      // SSE connection on the POST
      const data = new FormData(form);
      const es = new EventSource("/upload?" + new URLSearchParams(), {
        // note: most browsers don't allow POST for EventSource; if you hit CORS, switch to GET+query-string
      });

      // manually POST the form via fetch and then pipe its SSE back...
      fetch("/upload", { method:"POST", body:data })
        .then(r=>r.body.getReader())
        .then(reader=>{
          const decoder = new TextDecoder(), chunkBuf = [];
          function read() {
            reader.read().then(({value,done})=>{
              if(done) return;
              chunkBuf.push(decoder.decode(value));
              const s = chunkBuf.join("").split(/\r?\n\r?\n/);
              s.slice(0,-1).forEach(block=>{
                block.split(/\r?\n/).forEach(line=>{
                  if(!line) return;
                  const [prefix,rest] = line.split(":",2);
                  if(prefix==="event" && rest.trim()==="progress") currentEvent="progress";
                  if(prefix==="data"){
                    const payload = JSON.parse(rest.slice(1));
                    if(currentEvent==="progress"){
                      inner.style.width = payload.percent+"%";
                      eta.textContent = "ETA: "+payload.eta+"s";
                      let img=document.createElement("img");
                      img.src=payload.last_image;
                      img.className="thumb";
                      prev.appendChild(img);
                    }
                    if(currentEvent==="complete"){
                      barC.style.display="none";
                      zipA.href = payload.batch;
                      zipA.style.display="block";
                      document.getElementById("uploadBtn").disabled = false;
                    }
                  }
                });
              });
              read();
            });
          }
          read();
        })
        .catch(err=>{
          console.error(err);
          document.getElementById("uploadBtn").disabled = false;
        });
    }
  </script>
</body>
</html>
