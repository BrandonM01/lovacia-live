<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Lovacia Bot</title>
</head>
<body>
  <h1>Lovacia Bot</h1>

  <label>
    Select images:
    <input id="fileInput" type="file" multiple>
  </label>

  <h3>Original Thumbnails:</h3>
  <img id="origThumb" width="200" style="display:none">

  <div>
    <label>
      Batch size:
      <select id="batchSize">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
    </label>
    <br>
    <label>
      Contrast Min (%):
      <input id="contrastMin" type="number" step="0.1" value="-5">
    </label>
    <br>
    <label>
      Contrast Max (%):
      <input id="contrastMax" type="number" step="0.1" value="5">
    </label>
    <br>
    <label>
      Flip horizontally:
      <input id="flip" type="checkbox">
    </label>
    <br>
    <button id="cancelBtn" style="display:none">Cancel</button>
  </div>

  <button id="uploadBtn">Upload & Process</button>

  <h2>Progress:</h2>
  <div id="progress">Idle</div>

  <h2>Processed Images</h2>
  <div id="results"></div>

  <script>
    const fileInput   = document.getElementById("fileInput");
    const batchSize   = document.getElementById("batchSize");
    const contrastMin = document.getElementById("contrastMin");
    const contrastMax = document.getElementById("contrastMax");
    const flipToggle  = document.getElementById("flip");
    const uploadBtn   = document.getElementById("uploadBtn");
    const cancelBtn   = document.getElementById("cancelBtn");
    const origThumb   = document.getElementById("origThumb");
    const progressEl  = document.getElementById("progress");
    const resultsEl   = document.getElementById("results");
    let controller;

    uploadBtn.addEventListener("click", async () => {
      const files = Array.from(fileInput.files);
      if (!files.length) {
        return alert("Please select at least one image.");
      }

      uploadBtn.disabled = true;
      cancelBtn.style.display = "inline";
      progressEl.innerText = "Processingâ€¦";
      resultsEl.innerHTML = "";

      // show first thumbnail
      origThumb.src = URL.createObjectURL(files[0]);
      origThumb.style.display = "block";

      // build form
      const form = new FormData();
      form.append("batch_size", batchSize.value);
      form.append("contrast_min", contrastMin.value);
      form.append("contrast_max", contrastMax.value);
      form.append("flip", flipToggle.checked);
      files.forEach(f => form.append("files", f));

      controller = new AbortController();
      try {
        const res = await fetch("/upload", {
          method: "POST",
          body: form,
          signal: controller.signal
        });
        if (!res.ok) throw new Error(res.statusText);

        const { processed } = await res.json();
        processed.forEach(imgObj => {
          const a = document.createElement("a");
          a.href = imgObj.download_link;
          a.target = "_blank";
          const img = document.createElement("img");
          img.src = imgObj.image;
          img.width = 200;
          a.appendChild(img);
          resultsEl.appendChild(a);
        });

        progressEl.innerText = "Done!";
      } catch (err) {
        if (err.name === "AbortError") {
          progressEl.innerText = "Canceled.";
        } else {
          console.error(err);
          progressEl.innerText = "Error.";
        }
      } finally {
        uploadBtn.disabled = false;
        cancelBtn.style.display = "none";
      }
    });

    cancelBtn.addEventListener("click", () => {
      if (controller) controller.abort();
    });
  </script>
</body>
</html>
