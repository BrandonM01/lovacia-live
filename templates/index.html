<!DOCTYPE html>
<html>
<head>
  <title>Lovacia Bot</title>
</head>
<body>
  <h1>Lovacia Bot</h1>

  <label>
    Select images:
    <input id="fileInput" type="file" name="files" multiple>
  </label>
  <br>

  <!-- thumbnail of the *first* image while processing -->
  <h3>Original Thumbnail:</h3>
  <img id="origThumb" src="" width="200" style="display:none;" />

  <br><br>
  <button id="uploadBtn">Upload & Process</button>
  <button id="cancelBtn" style="display:none;">Cancel</button>

  <h2>Progress:</h2>
  <div id="progress">Idle</div>

  <h2>Processed Images</h2>
  <div id="results"></div>

  <script>
    const fileInput  = document.getElementById('fileInput');
    const origThumb  = document.getElementById('origThumb');
    const uploadBtn  = document.getElementById('uploadBtn');
    const cancelBtn  = document.getElementById('cancelBtn');
    const progress   = document.getElementById('progress');
    const results    = document.getElementById('results');

    let controller;  // for cancellation

    // 1) Show thumbnail on select
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) {
        origThumb.style.display = 'none';
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        origThumb.src = e.target.result;
        origThumb.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    // 2) Start upload & processing
    uploadBtn.addEventListener('click', async () => {
      if (!fileInput.files.length) return alert('Pick at least one file.');

      // reset UI
      results.innerHTML = '';
      progress.textContent = 'Starting…';
      uploadBtn.disabled = true;
      cancelBtn.style.display = '';

      // Cancel token
      controller = new AbortController();

      const form = new FormData();
      for (const f of fileInput.files) form.append('files', f);

      try {
        const resp = await fetch('/upload', {
          method: 'POST',
          body: form,
          signal: controller.signal
        });
        const data = await resp.json();

        // when done
        progress.textContent = `Done — ${data.processed.length} images`;
        for (const img of data.processed) {
          const a = document.createElement('a');
          a.href = img.download_link;
          a.download = '';
          const i = document.createElement('img');
          i.src = img.image;
          i.width = 200;
          a.appendChild(i);
          results.appendChild(a);
        }
      }
      catch (err) {
        if (err.name === 'AbortError') {
          progress.textContent = 'Cancelled by user';
        } else {
          console.error(err);
          progress.textContent = 'Error!';
        }
      }
      finally {
        uploadBtn.disabled = false;
        cancelBtn.style.display = 'none';
      }
    });

    // 3) Cancel button
    cancelBtn.addEventListener('click', () => {
      if (controller) controller.abort();
    });
  </script>
</body>
</html>
