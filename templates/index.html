<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Lovacia Bot</title>
</head>
<body>
  <h1>Lovacia Bot</h1>

  <label>
    Select images:
    <input id="fileInput" type="file" multiple>
  </label>
  <button id="uploadBtn">Upload & Process</button>
  <button id="cancelBtn" style="display:none">Cancel</button>

  <h3>Original Thumbnail:</h3>
  <img id="origThumb" width="200" style="display:none">

  <h2>Progress:</h2>
  <div id="progress">Idle</div>

  <h2>Processed Images</h2>
  <div id="results"></div>

  <script>
    const fileInput  = document.getElementById("fileInput");
    const uploadBtn  = document.getElementById("uploadBtn");
    const cancelBtn  = document.getElementById("cancelBtn");
    const origThumb  = document.getElementById("origThumb");
    const progressEl = document.getElementById("progress");
    const resultsEl  = document.getElementById("results");
    let controller;

    uploadBtn.addEventListener("click", async () => {
      const files = fileInput.files;
      if (!files.length) {
        return alert("Please select at least one image.");
      }

      // prepare for upload
      controller = new AbortController();
      uploadBtn.disabled = true;
      cancelBtn.style.display = "inline";
      progressEl.innerText = "Processing...";
      resultsEl.innerHTML = "";

      // show the first thumbnail
      origThumb.src = URL.createObjectURL(files[0]);
      origThumb.style.display = "block";

      try {
        const formData = new FormData();
        for (const f of files) formData.append("files", f);

        const res = await fetch("/upload", {
          method: "POST",
          body: formData,
          signal: controller.signal
        });
        if (!res.ok) throw new Error(`Status ${res.status}`);

        const data = await res.json();
        data.processed.forEach(imgObj => {
          const a = document.createElement("a");
          a.href = imgObj.download_link;
          a.target = "_blank";

          const img = document.createElement("img");
          img.src = imgObj.image;
          img.width = 200;
          a.appendChild(img);

          resultsEl.appendChild(a);
        });

        progressEl.innerText = "Done!";
      } catch (err) {
        if (err.name === "AbortError") {
          progressEl.innerText = "Canceled.";
        } else {
          console.error(err);
          progressEl.innerText = "Error.";
        }
      } finally {
        uploadBtn.disabled = false;
        cancelBtn.style.display = "none";
      }
    });

    cancelBtn.addEventListener("click", () => {
      if (controller) controller.abort();
    });
  </script>
</body>
</html>
